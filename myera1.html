<!DOCTYPE html>
<!--version 1, invalid-->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <script>
        var a = new Array();

        function handleFileSelect(evt) {
            var files = evt.target.files; // FileList object
            if (files[0]) {
                var reader = new FileReader();
                reader.readAsText(files[0]);
                reader.onload = loaded;
            }
        }

        function createAndDownloadFile(fileName, content) {
            var aTag = document.createElement('a');
            var blob = new Blob([content]);
            aTag.download = fileName;
            aTag.href = URL.createObjectURL(blob);
            aTag.click();
            URL.revokeObjectURL(blob);
        }

        function arraysEqual(a, b) {
            if (a.length != b.length)
                return false;

            for (var i = 0; i < a.length; i++)
                if (a[i] != b[i])
                    return false;
            return true;
        }

        testErasure = function (original, errors) {
            const t1 = Date.now();
            var bfrags = erasure.split(original, 40, 10);
            alert("split it");
            alert(bfrags);

            createAndDownloadFile("bfrags", bfrags);

            const t2 = Date.now();
            console.log("Erasure encode took " + (t2 - t1) + " mS");
            if (document.getElementById("encode") != null)
                document.getElementById("encode").innerHTML = "Encode took " + (t2 - t1) + "mS to generate " + bfrags.length + " fragments";
            for (var i = 0; i < errors; i++)
                bfrags[i] = new Uint8Array(bfrags[i].length);
            //alert("length");
            //alert(original.length);
            var decoded = erasure.recombine(bfrags, original.length, 40, 10);
            if (decoded.length > original.length)
                decoded = decoded.subarray(0, original.length);

            alert("decoded");
            alert(decoded);

            const decoder = new TextDecoder('utf-8');
            const ans = decoder.decode(decoded);
            //console.log(win1251decoder.decode(bytes)); // Привет, мир!
            alert("ans");
            alert(ans);

            createAndDownloadFile("ans", ans);

            const t3 = Date.now();

            if (!arraysEqual(original, decoded))
                throw "Decoded contents different from original!";
            if (document.getElementById("decode") != null)
                document.getElementById("decode").innerHTML += "Decode with " + errors + " errors suceeded in " + (t3 - t2) + "mS</br>";
            console.log("Erasure decode took " + (t3 - t2) + " mS");
            return Promise.resolve(true);
        }

        /*
               testChunkErasure = function () {
                   const raw = new Uint8Array(5*1024*1024);
                   for (var i = 0; i < raw.length; i++)
                       raw[i] = i & 0xff;

                   alert(raw);
                   // create a worker to do the erasure coding
                   var blob = new Blob(["onmessage = function(e) { postMessage(e.data); }"]);
                   // Obtain a blob URL reference to our worker 'file'.
                   var blobURL = window.URL.createObjectURL(blob);
                   var worker = new Worker(blobURL);
                   worker.onmessage = function (e) {
                       console.log(e.data);
                       testErasure(e.data.input, e.data.errors);
                       var nerrors = e.data.errors + 1;
                       if (nerrors < 12)
                           this.postMessage({ errors: nerrors, input: e.data.input });
                   };
                   worker.postMessage({ errors: 0, input: raw });
               }
       */

        /*
        //字符串转化成ArrayBuffer
        function str2ab(str) {
            var buf = new ArrayBuffer(str.length); // 每个字符占用1个字节
            var bufView = new Uint8Array(buf);
            for (var i = 0, strLen = str.length; i < strLen; i++) {
                bufView[i] = str.charCodeAt(i);
            }
            return buf;
        }
        */

        function loaded(evt) {
            var fileString = evt.target.result;
            alert(fileString);

            //const rawab = str2ab(fileString);
            //alert("raw arraybuffer");
            //alert(rawab);

            const encoder = new TextEncoder();
            const raw = encoder.encode(fileString);
            alert("raw");
            alert(raw);
            //console.log(raw);

            /*
            const raw = new Uint8Array(rawab);
            alert("raw uint8 array");
            alert(raw);
            */

            // create a worker to do the erasure coding
            var blob = new Blob(["onmessage = function(e) { postMessage(e.data); }"]);
            // Obtain a blob URL reference to our worker 'file'.
            var blobURL = window.URL.createObjectURL(blob);
            //alert(blobURL);
            var worker = new Worker(blobURL);
            worker.onmessage = function (e) {
                console.log(e.data);
                //alert(e.data);
                testErasure(e.data.input, e.data.errors);
                var nerrors = e.data.errors + 1;
                if (nerrors < 12)
                    this.postMessage({ errors: nerrors, input: e.data.input });
            };
            worker.postMessage({ errors: 0, input: raw });
        }

        //testChunkErasure(evt.target.result);
        //testChunkErasure();
    </script>

</head>
<body>

    <input type="file" id="file" name="files[]" multiple />

    <h1>Please wait during erasure code profiling...</h1>
    <div id="encode"></div>
    <div id="decode"></div>
    <div id="error"></div>
    <script type="text/javascript">
        var btn = document.getElementById('file');
        btn.addEventListener('change', handleFileSelect, false);
    </script>
    <script src="scripts/erasure.js"></script>
    <!script src="scripts/mytest.js"><!/script>

</body>
</html>