<!DOCTYPE html>
<!--myerasure_version4,
    clean invalid sentences-->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <script>
        var a = new Array();
        var filetype = new Array();
        var filename = new Array();
        var filesize;
        var numOfDivision = 40;
        var numOfAppend = 10;
        var randomarray = new Array;

        /* After file selected, list info(name, type)
         * and read filestream As ArrayBuffer
         * use FileReader, seemingly usable for Chrome & Firefox
         */
        function handleFileSelect(evt) {
            var files = evt.target.files; // FileList object
            filename = files[0].name;
            filetype = files[0].type;
            filesize = files[0].size;

            if (document.getElementById("info") != null)
                document.getElementById("info").innerHTML =
                    "<h3>file name</h3> " + filename
                    + "</br><h3>file type</h3> " + filetype
                    + "</br><h3>file size</h3> " + filesize / 1024  + " KB"
                    + "</br>Division " + numOfDivision
                    + " Append " + numOfAppend
                    + "</br></br>";

            if (files[0]) {
                var reader = new FileReader();
                reader.readAsArrayBuffer(files[0]);
                reader.onload = loaded;
            }
        }

        /*
         * 
         */
        function c() {
            var t = document.getElementById("txt");
            t.value = "我很好！";
        }

        //0530 add random
        function randomize(n) {
            for (var j = 0; j < n; j++) {
                randomarray[j] = j;
            }
            randomarray.sort(function () {
                return 0.5 - Math.random();
            });
            //0530show random
            if (document.getElementById("random") != null) {
                for (var j = 0; j < n; j++) {
                    document.getElementById("random").innerHTML += (randomarray[j] + " , ");
                }
                document.getElementById("random").innerHTML += "</br>";
            }
        }

        function handleNumberSet() {
            //alert(document.getElementById("Division").value);
            numOfDivision = Number(document.getElementById("Division").value);
            numOfAppend = Number(document.getElementById("Append").value);
        }

        /* Download file, using A Tag
         * fileName: Array
         * content: Uint8Array
         *
         */
        function createAndDownloadFile(fileName, content) {
            var aTag = document.createElement('a');
            var blob = new Blob([content], { type: filetype, name: filename });
            aTag.download = fileName;
            aTag.href = URL.createObjectURL(blob);
            aTag.click();
            URL.revokeObjectURL(blob);
        }

        testErasure = function (original, errors) {
            if (errors == 0) {
                randomize(numOfDivision + numOfAppend * 2);
                //alert(numOfDivision + numOfAppend * 2);
            }
            //alert(errors);
            const t1 = Date.now();
            var bfrags = erasure.split(original, numOfDivision, numOfAppend);
            //alert(original.length);
            //alert(filesize);
            const t2 = Date.now();//TIMING START
            console.log("Erasure encode took " + (t2 - t1) + " mS");

            if (document.getElementById("encode") != null)
                document.getElementById("encode").innerHTML = "Encode took " + (t2 - t1) + "mS to generate " + bfrags.length + " fragments</br>";

            //clean some parts to simulate error

            for (var i = 0; i < errors; i++) {
                bfrags[randomarray[i]] = new Uint8Array(bfrags[randomarray[i]].length);
            }


            var decoded = erasure.recombine(bfrags, original.length, numOfDivision, numOfAppend);
            if (decoded.length > original.length)
                decoded = decoded.subarray(0, original.length);

            const t3 = Date.now();//TIMING END

            //check when errors = 0 or 9
            if (errors == 0 | errors == 9) {
                alert("errors=" + errors+", decoded");
                createAndDownloadFile(filename, decoded);
            }

            //detect contents change
            if (!arraysEqual(original, decoded))
                throw "Decoded contents different from original!";
            if (document.getElementById("decode") != null)
                document.getElementById("decode").innerHTML += "Decode with " + errors + " errors suceeded in " + (t3 - t2) + "mS</br>";
            console.log("Erasure decode took " + (t3 - t2) + " mS");
            return Promise.resolve(true);
        }

        function loaded(evt) {
            var fileString = evt.target.result;
            raw = new Uint8Array(fileString);

            if (document.getElementById("info") != null)
                document.getElementById("info").innerHTML += "loaded as Uint8Array...</br></br>";

            // create a worker to do the erasure coding
            var blob = new Blob(["onmessage = function(e) { postMessage(e.data); }"]);
            // Obtain a blob URL reference to our worker 'file'.
            var blobURL = window.URL.createObjectURL(blob);

            var worker = new Worker(blobURL);
            worker.onmessage = function (e) {
                console.log(e.data);
                testErasure(e.data.input, e.data.errors);
                var nerrors = e.data.errors + 1;
                if (nerrors < 12)
                    this.postMessage({ errors: nerrors, input: e.data.input });
            };
            worker.postMessage({ errors: 0, input: raw });
        }

    </script>

</head>
<body>

    <input type="file" id="file" name="files[]" multiple />

    <input type="text" id="txt" value="你好吗？">
    <input type="button" value="修改" onclick="c()">
    <input type="text" id="Division" value=40>
    <input type="text" id="Append" value=10>
    <input type="button" value="修改" onclick="handleNumberSet()">


    <h1>Please wait during erasure code profiling...</h1>
    <div id="info"></div>
    <div id="encode"></div>
    <div id="random"></div>
    <div id="decode"></div>
    <div id="error"></div>
    <script type="text/javascript">
        var btn = document.getElementById('file');
        btn.addEventListener('change', handleFileSelect, false);
    /*
        var numOfDivisionBtn = document.getElementById('Division');
        var numOfAppendBtn = document.getElementById('Append');
        numOfDivisionBtn.addEventListener('change', handleNumberSet, false);
        numOfAppendBtn.addEventListener('change', handleNumberSet, false);
    */
    </script>
    <script src="scripts/erasure.js"></script>
    <script src="scripts/funcs.js"></script>
    <!--<script src="scripts/mytest.js"><!/script>-->

</body>
</html>