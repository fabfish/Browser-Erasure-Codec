<!DOCTYPE html>
<!--myerasure_version6,
    clean invalid sentences-->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <script>
        var a = new Array();
        var filetype = new Array();
        var filename = new Array();
        var filesize;
        var numOfDivision = 40;
        var numOfAppend = 10;
        var randomArray = new Array;

        /* After file selected, list info(name, type)
         * and read filestream As ArrayBuffer
         * use FileReader, seemingly usable for Chrome & Firefox
         * turn to upLoader()
         */
        function handleFileSelect(evt) {
            var files = evt.target.files; // FileList object
            if (files[0]) {
                filetype=files[0].type;
                filename=files[0].name;
                filesize=files[0].size;
                var reader = new FileReader();
                reader.readAsBinaryString(files[0]);
                reader.onload = upLoader;
            }
        }

        //0530 add random
        function randomize(n) {
            for (var j = 0; j < n; j++) {
                randomArray[j] = j;
            }
            randomArray.sort(function () {
                return 0.5 - Math.random();
            });
            //0530show random
            if (document.getElementById("random") != null) {
                for (var j = 0; j < n; j++) {
                    document.getElementById("random").innerHTML += (randomArray[j] + " , ");
                }
                document.getElementById("random").innerHTML += "</br>";
            }
        }

        /* handleNumberSet: from the text blocks, get the number*/
        function handleNumberSet() {
            numOfDivision = Number(document.getElementById("Division").value);
            numOfAppend = Number(document.getElementById("Append").value);
        }

        /* Download file, using A Tag
         * fileName: Array
         * content: Uint8Array*/
        function createAndDownloadFile(fileName, content) {
            var aTag = document.createElement('a');
            var blob = new Blob([content], { type: filetype, name: filename });
            aTag.download = fileName;
            aTag.href = URL.createObjectURL(blob);
            aTag.click();
            URL.revokeObjectURL(blob);
        }

        /* user choose a file, and trigger handleFileSelect -> upLoader
        * upLoader get the file in .result as raw, then create a worker to do encoding
        */
        function upLoader(evt) {
            /*receive file*/
            var fileString = evt.target.result;
            if (document.getElementById("info") != null)
                document.getElementById("info").innerHTML += "loaded as Uint8Array...</br></br>";
            raw = new Uint8Array(fileString);
            var fileName = filename;
            var fileType = filetype;
            var fileSize = filesize;

            if (document.getElementById("info") != null)
                document.getElementById("info").innerHTML =
                    "<h3>file name</h3> " + fileName
                    + "</br><h3>file type</h3> " + fileType
                    + "</br><h3>file size</h3> " + fileSize / 1024  + " KB"
                    + "</br>Division " + numOfDivision
                    + " Append " + numOfAppend
                    + "</br></br>";
            
            var decoded = erasure.recombine(raw, filesize, numOfDivision, numOfAppend);
            if (decoded.length > filesize)
                decoded = decoded.subarray(0, original.length);
            createAndDownloadFile(filename, decoded);

        }

        function downLoader(){
            var fileName = new Array();
            var fileType = new Array();
            var bfrags =new Array();
            var digest = new Array();
            recvFragments(fileName,fileType,numOfDivision,numOfAppend,bfrags,digest);
            //clean some parts to simulate error
            for (var i=0;i<bfrags.length;i++){
                if (digest[i]!=objectHash.MD5(bfrags[i]))
                    bfrags[i] = new Uint8Array(bfrags[i].length);
            }
            //need filesize
            //var decoded = erasure.recombine(bfrags, bfrags.size, numOfDivision, numOfAppend);
            /*
            if (decoded.length > filesize)
                decoded = decoded.subarray(0, original.length);

            const t3 = Date.now();//TIMING END

            //check when errors = 0 or 9
            if (errors == 0 | errors == 9) {
                alert("errors=" + errors+", decoded");
                createAndDownloadFile(filename, decoded);
            }

            //detect contents change
            if (!arraysEqual(original, decoded))
                throw "Decoded contents different from original!";
            if (document.getElementById("decode") != null)
                document.getElementById("decode").innerHTML += "Decode with " + errors + " errors suceeded in " + (t3 - t2) + "mS</br>";
            console.log("Erasure decode took " + (t3 - t2) + " mS");
            return Promise.resolve(true);
            */
        }


    </script>

</head>
<body>

    <input type="file" id="file" name="files[]" multiple />
    <input type="text" id="Division" value=40 >
    <input type="text" id="Append" value=10 >
    <input type="button" value="修改" onclick="handleNumberSet()" />
    <h3>Please wait during erasure code profiling...</h3>
    <div id="info"></div>
    <div id="encode"></div>
    <div id="random"></div>
    <div id="decode"></div>
    <div id="error"></div>
    <script type="text/javascript">
        var btn = document.getElementById('file');
        btn.addEventListener('change', handleFileSelect, false);
    </script>
    <script src="scripts/object_hash.js" type="text/javascript"></script>
    <script src="scripts/erasure.js"></script>
    <script src="scripts/funcs.js"></script>
</body>
</html>